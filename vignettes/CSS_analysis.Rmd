---
title: "CSS Analysis using PhILR"
author: "Justin Silverman"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{CSS Analysis using PhILR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This is a demo analysis to recreate some of the results from the PhILR paper. We will be using a copy of the dataset that has been preprocessed and included in the PhILR package. 

Specifically it has had the following preprocessing:

1. The tree was rooted by randomly rooting with a member of the "Plantomycetes" phylum as an outgroup. 
2. Multichotomies were resolved to dichotomies with the ape packages multi2di function. 
3. Subset Costello data to only contain the Skin sites (BODY_HABITAT=="UBERON:skin")
4. Taxa were filtered, only those taxa that were seen with > 10 counts accross all samples were retianed. 
5. Internal nodes on the tree were labeled. 

```{r}
library(philr)
library(phyloseq)
```


Now we load the stored data and add a small pseudocount of 1 to deal with zero values. 
```{r}
data(CSS)
df <- t(otu_table(CSS)) + 1
tree <- phy_tree(CSS)
```

Now we transform the data using the aitchison norm times the geometric mean of the counts as the weighting of the parts and the square root of the sum of each nodes two children's branch length as the weighting of the ILR coordinates. Note that the warning reguarding the 44 tips with zero length edges is the expected behavior of philr. 
```{r}
df.philr <- philr(df, tree, part.weights='anorm.x.gm.counts', ilr.weights='blw.sqrt')
```


From here we can now visualize some of the balances and how different bodysites look along them. Note for these plotting functions we first want to convert the transformed data into long format. 
```{r}
df.philr.long <- convert_to_long(df.philr, get_variable(CSS, 'BODY_SITE'))
plot_balance('n7', tree)
plot_density_breakdown(df.philr.long, 'n7', tax_table(CSS))
```
